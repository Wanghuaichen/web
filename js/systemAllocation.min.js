/**
 * Created by admin on 2015/11/2.
 */$(function(){function p(a,c,b){var d="detail"+a;$("#userSystem tbody").append("\x3ctr id\x3d'app_"+a+"'\x3e\x3ctd style\x3d'display: none'\x3e"+c+"\x3c/td\x3e\x3ctd\x3e\x3cinput name\x3d'checkbox1' class\x3d'nosort' type\x3d'checkbox' id\x3d'checkbox_"+a+"'/\x3e\x3c/td\x3e\x3ctd\x3e"+b+"\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d'#' class\x3d'tablelink' id\x3d'"+d+"'\x3e\u67e5\u770b\u529f\u80fd\u6743\u9650\x3c/a\x3e\x3c/td\x3e\x3c/tr\x3e");$(document).on("click","#"+d,function(){$("#funcTable tbody").empty();$("#funcTable tbody").html("");var a=$(this).parent().parent().children("td").eq(0).text(),c=JSON.parse(a);q.dialog("open");var a=c.appName,b=$("#userlist option:selected").val(),b=JSON.parse(b),d=void 0==b.faId?b.id:b.faId;"root"==v().type?$("#funcsure").css("display","inline"):d==v().userId?$("#funcsure").css("display","inline"):$("#funcsure").css("display","none");b=listuserperm(b.id,a);b=JSON.parse(b);if("success"==b.errCode)for(q.dialog("option","update","true"),b=b.permission,d=0;d<b.length;d++){if(c=b[d],c.appName==a)for(var k=c.permList,e=0;e<k.length;e++){var c=e+1,n=JSON.parse(k[e]),g;for(g in n){var p=g,r=n[g],r="read"==r?"\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' checked\x3d'checked' value\x3d'read'\x3e\u8bfb\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' value\x3d'write'\x3e\u5199":"write"==r?"\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' value\x3d'read'\x3e\u8bfb\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' checked\x3d'checked'  value\x3d'write'\x3e\u5199":"\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' checked\x3d'checked' value\x3d'read'\x3e\u8bfb\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' checked\x3d'checked'  value\x3d'write'\x3e\u5199";$("#funcTable tbody").append("\x3ctr id\x3d'app_"+c+"'\x3e\x3ctd style\x3d'display: none'\x3e"+a+"\x3c/td\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3ctd\x3e"+p+"\x3c/td\x3e\x3ctd\x3e"+r+"\x3c/td\x3e\x3c/tr\x3e")}}}else if("noItem"==b.errCode)for(q.dialog("option","update","false"),g=c.funcPerm,b=0;b<g.length;b++)c=b+1,r="\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' checked\x3d'checked' value\x3d'read'\x3e\u8bfb\x3cinput type\x3d'checkbox' name\x3d'rwcheckbox' value\x3d'write'\x3e\u5199",$("#funcTable tbody").append("\x3ctr id\x3d'app_"+c+"'\x3e\x3ctd style\x3d'display: none'\x3e"+a+"\x3c/td\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3ctd\x3e"+g[b]+"\x3c/td\x3e\x3ctd\x3e"+r+"\x3c/td\x3e\x3c/tr\x3e")})}function t(a,c,b){$("#allSystem tbody").append("\x3ctr id\x3d'app_"+a+"'\x3e\x3ctd style\x3d'display: none'\x3e"+c+"\x3c/td\x3e\x3ctd\x3e\x3cinput name\x3d'checkbox2' class\x3d'nosort' type\x3d'checkbox' id\x3d'checkbox_"+a+"'/\x3e\x3c/td\x3e\x3ctd\x3e"+b+"\x3c/td\x3e\x3c/tr\x3e")}function w(){$("#userSystem tbody").empty();$("#userSystem tbody").html("");$("#allSystem tbody").empty();$("#allSystem tbody").html("");var a=listapp({all:""}),a=JSON.parse(a);if("success"==a.errCode){var c=a.appList,b=$("#userlist option:selected").val();if(""!=b&&void 0!=b)for(var b=JSON.parse(b),b=void 0==b.appName?[]:b.appName,d=0;d<b.length;d++){var h=b[d],a={};a.appName=h;a=listapp(a);a=JSON.parse(a);if("success"==a.errCode){for(var f=0;f<c.length;f++)c[f].appName==h&&c.splice(f,1);p(d+1,JSON.stringify(a.appList[0]),h)}}b=c.length;for(d=0;d<b;d++)h=c[d].appName,a=JSON.stringify(c[d]),t(d+1,a,h)}}function x(){$("#userlist").empty();var a=$("#orglist option:selected").val().trim(),c={};c.orgId=a;a=listuser(c);a=JSON.parse(a);if("success"==a.errCode)for(a=a.accountList,c=0;c<a.length;c++){var b=a[c].userName;$("\x3coption value\x3d"+JSON.stringify(a[c]).replace(" ","")+"\x3e"+b+"\x3c/option\x3e").appendTo($("#userlist"))}w()}function u(a,c){var b=$("#userlist option:selected").val();if(""!=b&&void 0!=b)for(var d=JSON.parse(b),b=0;b<c.length;b++){var h=c[b],f=JSON.parse(h),l=f.appName;if("left"==a){for(var f=f.funcPerm,m="",k=[],e=0;e<f.length;e++){var m=m+(f[e]+"|"),n={};n[f[e]]="read";k.push(n)}m=m.substring(0,m.length-1);y("create",d,l,m,k,h)}else"right"==a&&y("del",d,l,"","",h)}else{alert("\u5f53\u524d\u6ca1\u6709\u9009\u62e9\u4efb\u4f55\u7528\u6237\u4fe1\u606f\uff01");for(b=0;b<c.length;b++)d=b+1,h=c[b],f=JSON.parse(h),l=f.appName,"left"==a?t(d,h,l):p(d,h,l);return!1}}function y(a,c,b,d,h,f){var l=$("#allSystem tbody tr").length+1,m=$("#userSystem tbody tr").length+1,k={},e=void 0==c.appName?[]:c.appName,n="";if("create"==a){e.push(b);a="";for(var g in e)a+=e[g]+"|";k.appName=a.substring(0,a.length-1);n=updateuser(c.id,k);a=JSON.parse(n);if("success"==a.errCode)if(d=createuserperm(c.id,b,d,h),"success"==JSON.parse(d).errCode)p(m,f,b);else{alert("\u5de6\u79fb\u5e94\u7528"+b+"\u5931\u8d25\uff01");t(l,f,b);e.splice(jQuery.inArray(b,e),1);a="";for(g in e)a+=e[g]+"|";k.appName=a.substring(0,a.length-1);updateuser(c.id,k)}else alert("\u4fee\u6539\u7528\u6237\u5e94\u7528"+b+"\u5931\u8d25\uff01"),t(l,f,b)}else{a="";for(g in e)e[g]!=b&&"0"!=e[g]&&(a+=e[g]+"|");k.appName=a.substring(0,a.length-1);n=updateuser(c.id,k);a=JSON.parse(n);if("success"==a.errCode)if(d=deleteuserperm(c.id,b),"success"==JSON.parse(d).errCode)t(l,f,b),e.splice(jQuery.inArray(b,e),1);else{alert("\u53f3\u79fb\u5e94\u7528"+b+"\u5931\u8d25\uff01");p(m,f,b);a="";for(g in e)a+=e[g]+"|";k.appName=a.substring(0,a.length-1);updateuser(c.id,k)}else alert("\u4fee\u6539\u7528\u6237\u5e94\u7528"+b+"\u5931\u8d25\uff01"),p(m,f,b)}c.appName=e;$("#userlist option:selected").val(JSON.stringify(c))}function v(){var a=getCookie("userInfo");console.log("cookie\x3d"+a);return JSON.parse(a).account}$("#checkAll1").click(function(){$(this).is(":checked")?$("input[name\x3d'checkbox1']").each(function(){$(this).prop("checked",!0)}):$("input[name\x3d'checkbox1']").each(function(){$(this).prop("checked",!1)})});$("#checkAll2").click(function(){$(this).is(":checked")?$("input[name\x3d'checkbox2']").each(function(){$(this).prop("checked",!0)}):$("input[name\x3d'checkbox2']").each(function(){$(this).prop("checked",!1)})});var q;q=$("#funcDialog").dialog({autoOpen:!1,height:350,width:530,modal:!0,buttons:[{text:"\u63d0\u4ea4",click:function(){var a,c="",b=[];$("#funcTable tbody tr").each(function(){a=$(this).children("td").eq(0).text();var d=$(this).children("td").eq(2).text();c+=d+"|";var f="";$(this).children("td").children("input").each(function(){if($(this).is(":checked")){var a=$(this).val();f+=a+"|"}});var l={};l[d]=f.substring(0,f.length-1);b.push(l)});var d=$("#userlist option:selected").val(),d=JSON.parse(d);"success"!=("true"==q.dialog("option","update")?JSON.parse(updateuserperm(d.id,a,c.substring(0,c.length-1),b)):JSON.parse(createuserperm(d.id,a,c,b))).errCode&&alert("\u4fee\u6539\u7528\u6237\u5e94\u7528\u6743\u9650\u5931\u8d25\uff01");q.dialog("close")},"class":"sure",id:"funcsure"},{text:"\u5173\u95ed",click:function(){q.dialog("close")},"class":"cancel"}]});$("#orglist").change(function(){x()});$("#userlist").change(function(){w()});$("#btnLeftAll").click(function(){var a=[];$("input[type\x3dcheckbox][name\x3dcheckbox2]").each(function(){var c=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();a.push(c)});u("left",a)});$("#btnLeft").click(function(){var a=[];$("input[type\x3dcheckbox][name\x3dcheckbox2]:checked").each(function(){var c=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();a.push(c)});u("left",a)});$("#btnRight").click(function(){var a=[];$("input[type\x3dcheckbox][name\x3dcheckbox1]:checked").each(function(){var c=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();a.push(c)});u("right",a)});$("#btnRightAll").click(function(){var a=[];$("input[type\x3dcheckbox][name\x3dcheckbox1]").each(function(){var c=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();a.push(c)});u("right",a)});(function(){var a=listorg({all:""}),a=JSON.parse(a);if("success"==a.errCode){for(var a=a.orgList,c=0;c<a.length;c++)"factory"!=a[c].type&&$("\x3coption value\x3d"+a[c].id+"\x3e"+a[c].name+"\x3c/option\x3e").appendTo($("#orglist"));x()}})()});