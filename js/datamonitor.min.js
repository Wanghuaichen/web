$(function(){function u(k){B=[];var g={},e={};g.max="2000";g.start="0";var b=null,b={},f=$("#starthour").val(),c=$("#endhour").val();b.family=v;if("historyTable"==k&&""!=f){C=[];var c=new Date(c),a={scale:"day"};a.start=(new Date(f)).getTime();a.end=c.getTime();b.time=a;b=JSON.parse(datahistory(b,g,e))}else x=[],b=JSON.parse(datanow(b,g,e));if("success"==b.errCode)if(g=null,void 0==b.poluList){var l=g=b.resultList,h={},m={},p;for(p in l){var d=l[p].dayResult,g=l[p].day,q;for(q in d){var n=d[q];n.day=g;e=void 0==n.factory.id?"":n.factory.id;b=Number(void 0==n.actMax?"0":n.actMax);f=Number(void 0==n.actMin?"0":n.actMin);c=Number(void 0==n.min?"0":n.min);a=Number(void 0==n.max?"0":n.max);n=JSON.stringify(n);if(b>a||f<c)void 0==m[e]&&(m[e]=[]),m[e].push(n);if(void 0==h[e]||null==h[e])h[e]=[];h[e].push(n)}}D(k,h)}else{g=b.poluList;p={};q={};for(d in g){e=JSON.stringify(g[d]);b=g[d];f=void 0==b.factory.id?"":b.factory.id;c=b.higher;if("yes"==b.lower||"yes"==c)void 0==q[f]&&(q[f]=[]),q[f].push(JSON.stringify(e));if(void 0==p[f]||null==p[f])p[f]=[];p[f].push(e)}d="";g=0;e="";$("#realAlarmList").html("");for(l in q)for(h in b=JSON.parse(q[l]),b){a=JSON.parse(b[h]);f=a.family;c=a.value;if(void 0==c)for(m in n=a.values,n)c=Number(n[m].avg);var n=void 0==a.min?0:a.min,t=void 0==a.max?0:a.max,a=void 0==a.devId?0:a.devId;g++;c>t?e="\u8d85\u4e0a\u9650":c<n&&(e="\u8d85\u4e0b\u9650");d+="\x3cdiv\x3e"+g+"\u3001\u8bbe\u5907\uff1a"+a+"\u4e0a\u7684\u6307\u6807\uff1a"+f+e+"!\x3c/div\x3e"}d+="\x3cdiv\x3e1\u3001\u8bbe\u5907\uff1a2015089880000\u4e0a\u7684\u6307\u6807\uff1aO2\u8d85\u4e0a\u9650!\x3c/div\x3e";$("#realAlarmList").html(d);D(k,p,q)}}function D(k,g){$("#"+k+" tbody").empty();$("#"+k+" tbody").html("");var e=0,b;for(b in g){var f=g[b],c={},a={},l=0,h=0,m=0,p="",d="",q={};q.orgId=b;for(var n in f){var d=JSON.parse(f[n]),t=d.family,w=d.value;if(void 0==w){var l=d.values,u;for(u in l)w=Number(l[u].avg)}h=void 0==d.min?0:d.min;l=void 0==d.max?0:d.max;p=void 0==d.devId?0:d.devId;d=void 0==d.unit?0:d.unit;void 0==c[t]&&(c[t]=0,a[t]=0);w>m&&(m=w);c[t]++;a[t]+=w}f=JSON.parse(listorg(q));if("success"==f.errCode){var f=f.orgList,v;for(v in f){var q=f[v],m=JSON.stringify(q),q=q.name,w=a[t]/c[t],r=[];r.push(q);r.push(Number(w.toFixed(3)));B.push(r);e++;r={};r.str=m;r.factoryName=q;r.value=w.toFixed(3);r.range=h+"-"+l;r.unit=d;r.devId=p;"historyTable"==k?C.push(r):x.push(r);y(k,m,e,q,w.toFixed(3),h+"-"+l,d,p)}}}sorter.init(k,1);E()}function y(k,g,e,b,f,c,a,l){var h="detail"+e;$("#"+k+" tbody").append("\x3ctr id\x3d'app_"+e+"'\x3e\x3ctd style\x3d'display: none'\x3e"+g+"\x3c/td\x3e\x3ctd style\x3d'width: 6%'\x3e"+e+"\x3c/td\x3e\x3ctd\x3e"+b+"\x3c/td\x3e\x3ctd\x3e"+f+"\x3c/td\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3ctd\x3e"+a+"\x3c/td\x3e\x3ctd\x3e"+l+"\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d'../comprehensiveMonitor/siteDetail.html' class\x3d'tablelink'target\x3d'rightFrame' id\x3d'"+h+"'\x3e \u67e5\u770b\u8be6\u60c5\x3c/a\x3e\x3c/tr\x3e");$(document).on("click","#"+h,function(){var a=JSON.parse($(this).parent().parent().children("td").eq(0).text()),b=$("#starthour").val(),d=$("#endhour").val(),c={};c.name=a.name;c.id=a.id;""!=b&&""!=d&&(a=new Date(d),c.startTime=(new Date(b)).getTime(),c.endTime=a.getTime());setCookie("siteDetail",JSON.stringify(c))})}function F(k,g){z=[];B=[];var e={},b={},f=[],c={};e.max="2000";e.start="0";c.asc="time";var a=null,l={};l.family=g;l.hilo="higher|lower";if("historyWarm"==k&&""!=alarmStartTime){var h=$("#alarmstarthour").val(),a=$("#alarmendhour").val(),m=new Date(a),a={scale:"all"};a.start=(new Date(h)).getTime();a.end=m.getTime();l.time=a;a={};a.find=l;a.page=e;a.sort=c;f.push(a);b.multiFind=f;a=JSON.parse(datahistory(l,e,b,!0))}$("#alarmHistoryTable tbody").empty();$("#alarmHistoryTable tbody").html("");if(null!=a){var e=a.multiResult,b=0,p;for(p in e)if("success"==e[p].errCode)for(p in f=e[p].resultList,f){var c=f[p].dayResult,d;for(d in c){l=JSON.stringify(c[d]);h=void 0==c[d].dvalue?"":c[d].dvalue;m=void 0==c[d].factory?"":void 0==c[d].factory.name?"":c[d].factory.name;g=void 0==c[d].family?"":c[d].family;var q=void 0==c[d].dmax?"":c[d].dmax,n=void 0==c[d].dmin?"":c[d].dmin,t=void 0==c[d].unit?"":c[d].unit,w=void 0==c[d].higher?"":c[d].higher,u=void 0==c[d].lower?"":c[d].lower,a=void 0==c[d].time?"":c[d].time,v=void 0==c[d].devId?"":c[d].devId,r="",x="",r="yes"==w?"\u8d85\u4e0a\u9650":"yes"==u?"\u8d85\u4e0b\u9650":"\u6b63\u5e38",x=dataFormate(1E3*a,"yyyy/MM/dd HH:mm:ss");b++;a={};a.str=l;a.family=g;a.value=h;a.min=n;a.max=q;a.unit=t;a.date=x;a.factoryname=m;a.state=r;a.devId=v;z.push(a);H(b,l,g,h,n,q,t,x,m,r)}}0!=b&&($("#showNoData").css("display","none"),sorter.init("alarmHistoryTable",1))}else $("#showNoData").css("display","block")}function H(k,g,e,b,f,c,a,l,h,m){var p="detail"+k;b="\x3ctd\x3e"+b+"\x3c/td\x3e";var d="\x3ctd\x3e"+m+"\x3c/td\x3e",q="\x3ctd\x3e\x3ca href\x3d'../environmental/indicatorDetail.html' class\x3d'tablelink'target\x3d'rightFrame' id\x3d'"+p+"'\x3e \u67e5\u770b\u8be6\u60c5\x3c/a\x3e";if("\u8d85\u4e0b\u9650"==m||"\u8d85\u4e0a\u9650"==m)d="\x3ctd style\x3d'color: red; font-weight: 800;'\x3e"+m+"\x3c/td\x3e";"\u65e0\u72b6\u6001"==m&&(d="\x3ctd style\x3d'color: #eabc14;font-weight: 800;'\x3e"+m+"\x3c/td\x3e");$("#alarmHistoryTable tbody").append("\x3ctr id\x3d'app_"+k+"'\x3e\x3ctd style\x3d'display: none'\x3e"+g+"\x3c/td\x3e\x3ctd style\x3d'width: 6%'\x3e"+k+"\x3c/td\x3e\x3ctd\x3e"+h+"\x3c/td\x3e\x3ctd\x3e"+e+"\x3c/td\x3e"+b+"\x3ctd\x3e"+f+"-"+c+"\x3c/td\x3e\x3ctd\x3e"+a+"\x3c/td\x3e\x3ctd\x3e"+l+"\x3c/td\x3e"+d+q+"\x3c/tr\x3e");$(document).on("click","#"+p,function(){var a=$(this).parent().parent().children("td").eq(0).text(),b={};b.startTime=A;b.endTime=G;setCookie("indicatordata",a);setCookie("alarmInfo",JSON.stringify(b))})}function E(){var k=[],g={},e=[],b=B.sort(function(a,b){return b[1]-a[1]}),f;for(f in b){var c=b[f],a=f;(c[1]/b[0][1]).toFixed(3);a++;a={};a.name=c[0];a.y=c[1];e.push(a)}g.colorByPoint=!0;g.data=e;k.push(g);new Highcharts.Chart({chart:{renderTo:"dataMonitorContainer",type:"column"},title:{useHTML:!0,text:v+"\u7ad9\u70b9\u5bf9\u6bd4\u56fe"},xAxis:{type:"category",endOnTick:!0,labels:{}},yAxis:{title:{text:""},plotLines:[]},legend:{enabled:!1},tooltip:{crosshairs:[!0,!0],shared:!0,useHTML:!0,headerFormat:'\x3cspan style\x3d"font-size:11px"\x3e\x3c/span\x3e',pointFormat:'\x3cspan style\x3d"color:{point.color}"\x3e{point.name}\x3c/span\x3e: \x3cb\x3e{point.y:.2f}\x3c/b\x3e\x3cbr/\x3e'},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y:.2f}"}}},series:k})}function I(k,g,e){return{elem:k,istime:g,isclear:!1,istoday:!1,format:e,issure:!1,start:laydate.now(0),max:laydate.now(0),choose:function(b){alarmStartTime=A=b}}}function J(k,g){return{elem:k,istime:!0,isclear:!1,istoday:!1,format:"YYYY/MM/DD",issure:!1,start:laydate.now(0),min:g,max:laydate.now(0),choose:function(e){alarmEndTime=G=e;"#endhour"==k?u("historyTable"):F("historyWarm",v)}}}$("#searchType").change(function(){$("#searchByName").val("")});$("#searchpng").click(function(){var k=$("#searchByName").val();if(""!=k){var g=$("#realtime").attr("class"),e=$("#history").attr("class"),b=$("#historyWarm").attr("class");if("selected"==g&&null!=x){$("#realTimeTable tbody").empty();$("#realTimeTable tbody").html("");for(var f in x){var b=x[f],c=b.str,a=b.factoryName,g=b.value,l=b.range,e=b.unit,b=b.devId;((new RegExp(k)).test(b)||(new RegExp(k)).test(a))&&y("realTimeTable",c,++f,a,g,l,e,b)}}else if("selected"==e&&null!=C)for(f in $("#historyTable tbody").empty(),$("#historyTable tbody").html(""),C)b=x[f],c=b.str,a=b.factoryName,g=b.value,l=b.range,e=b.unit,b=b.devId,((new RegExp(k)).test(b)||(new RegExp(k)).test(a))&&y("realTimeTable",c,++f,a,g,l,e,b);else if("selected"==b&&null!=z)for(f in $("#alarmHistoryTable tbody").empty(),$("#alarmHistoryTable tbody").html(""),z){var h=z[f],c=h.str,a=h.family,g=h.value,l=h.min,m=h.max,e=h.unit,p=h.date,d=h.factoryname,b=h.devId,h=h.state;((new RegExp(k)).test(b)||(new RegExp(k)).test(d))&&H(++f,c,a,g,l,m,e,p,d,h)}}});$("#starthour").click(function(){laydate(I("#starthour",!0,"YYYY/MM/DD"));addLaydateListener()});$("#endhour").click(function(){laydate(J("#endhour",A));$("#laydate_ms span").click(function(){addLaydateListener()});$("#laydate_ys li").click(function(){addLaydateListener()});addLaydateListener()});$("#alarmstarthour").click(function(){laydate(I("#alarmstarthour",!0,"YYYY/MM/DD"));addLaydateListener()});$("#alarmendhour").click(function(){laydate(J("#alarmendhour",A));$("#laydate_ms span").click(function(){addLaydateListener()});$("#laydate_ys li").click(function(){addLaydateListener()});addLaydateListener()});$("#realtime").click(function(){sortOp("realTimeTable","realCurrentpage","realPagelimit");u("realTimeTable");$("#searchpng").click();E()});$("#history").click(function(){sortOp("historyTable","historyCurrentpage","historyPagelimit");u("historyTable");$("#searchpng").click();E()});$("#realWarm").click(function(){F("realWarm",v)});$("#historyWarm").click(function(){sortOp("alarmHistoryTable","currentpage","pagelimit");F("historyWarm",v);$("#searchpng").click();E()});$(".siteCompare").click(function(){K.dialog("open")});var K=$("#compareWindow").dialog({position:{my:"center",at:"center",of:window},autoOpen:!1,height:380,width:530,modal:!0,closeText:"\u6700\u5c0f\u5316"}),A=alarmStartTime=dataFormate((new Date).getTime()-864E5,"yyyy/MM/dd HH:mm:ss"),G=alarmEndTime=dataFormate((new Date).getTime(),"yyyy/MM/dd HH:mm:ss");$("#starthour").val(A);$("#endhour").val(G);$("#alarmstarthour").val(alarmStartTime);$("#alarmendhour").val(alarmEndTime);sortOp("realTimeTable","realCurrentpage","realPagelimit");var v=getCookie("monitorMenu"),B,x,C,z;$("#currentPagetitle").text(v+"\u76d1\u6d4b");u("realTimeTable")});function sortOp(u,D,y){sorter.head="head";sorter.asc="asc";sorter.desc="desc";sorter.even="evenrow";sorter.odd="oddrow";sorter.evensel="evenselected";sorter.oddsel="oddselected";sorter.paginate=!0;sorter.currentid=D;sorter.limitid=y;sorter.init(u,2);sorter.size(10)}var sorter=new TINY.table.sorter("sorter");