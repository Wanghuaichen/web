/**
 * Created by admin on 2015/11/17.
 */$(function(){function K(n,a){var x=$("#nowcontainer").highcharts();x.series[0].name=n;x.setTitle({useHTML:!0,text:n+"("+L+")\x3cbr\x3e\x3clabel style\x3d'font-size: x-small;color: red'\x3e(\u9608\u503c\uff1a"+l+"-"+h+")\x3c/label\x3e"});var b={};b.family=n;b.devId=H;b.name=N;var c={},f={};c.max="2000";c.start="0";f.sort={asc:"time"};b=datanow(b,c,f);c=JSON.parse(b);b=c.time;if("success"==c.errCode)for(var c=c.poluList,f=c.length,g=0;g<f;g++){JSON.stringify(c[g]);var k=void 0==c[g].value?"":c[g].value,m=void 0==c[g].time?"":c[g].time,q=b-m;1==/^-?\d+(\.\d+)?$/.test(k)&&(3E4!=a||3E4==a&&6E4>=q)&&(q=[],q.push(m),q.push(k),x.series[0].addPoint(q))}}function y(){var n={},a={},x={};n.max="2000";n.start="0";a.family=E;a.uid=I;a.devId=H;x.sort={asc:"time"};var b={},c=$("#searchType option:selected").val(),f=new Date(m);b.end=(new Date(k)).getTime()+(864E5-1);"hour"==c&&(b.scale="hour",b.end-=864E5-1);"day"==c?b.scale="day":"month"==c?b.scale="month":"year"==c?b.scale="year":"minute"==c?(b.scale="minute",b.end-=864E5-1):"minute10"==c?(b.scale="minute10",b.end-=864E5-1):"all"==c&&(b.scale="all");f=new Date(f.getTime());b.start=f.getTime();a.time=b;a.uid=I;var b=datahistory(a,n,x),b=JSON.parse(b),n=[],a=[],x=[],c=[],g=f=0,d=0,e=0;if("success"==b.errCode&&0!=b.total){var q=b.resultList,l=/^-?\d+(\.\d+)?$/,h;for(h in q)for(var D in q[h]){var z=q[h].dayResult,u=void 0==q[h].day?"":q[h].day,A;for(A in z)if(void 0==z[A].dvalue){var r=void 0==z[A].values?"":z[A].values,t;for(t in r){var F=[],w=[],y=[],v=[],B=void 0==r[t].min?"":Number(r[t].min).toFixed(3),C=void 0==r[t].max?"":Number(r[t].max).toFixed(3),p=void 0==r[t].avg?"":Number(r[t].avg).toFixed(3),b=void 0==r[t].time?"":r[t].time,B=Number(B),C=Number(C),G=u.substring(0,4)+"/"+u.substring(4,6)+"/"+u.substring(6,8),b=new Date(G+" "+b);1==l.test(p)&&1==l.test(B)&&1==l.test(C)&&(0==e&&(g=C,f=B),e++,d+=Number(p),C>g&&(g=C),B<f&&(f=B),F.push(b.getTime()),F.push(Number(p)),n.push(F),w.push(b.getTime()),w.push(Number(C)),a.push(w),y.push(b.getTime()),y.push(Number(B)),x.push(y),v.push(b.getTime()),v.push(Number(B)),v.push(Number(C)),c.push(v))}}else p=void 0==z[A].dvalue?"":Number(z[A].dvalue).toFixed(3),1==l.test(p)&&(b=void 0==z[A].time?"":z[A].time,0==e&&(f=g=p),e++,d+=Number(p),p>g&&(g=p),p<f&&(f=p),F=[],F.push(1E3*b),F.push(Number(p)),n.push(F))}}$("#indicatorMax").text(Number(g).toFixed(2)+";");$("#indicatorMin").text(Number(f).toFixed(2)+";");0==e?$("#indicatorAvg").text(d):$("#indicatorAvg").text((d/e).toFixed(2));n.sort(function(b,a){return b[0]-a[0]});c.sort(function(b,a){return b[0]-a[0]});T(J,n,c)}function T(a,d,e){$("#historycontainer").highcharts("StockChart",{rangeSelector:{selected:1},title:{useHTML:!0,text:E+"("+L+")\x3cbr\x3e\x3clabel style\x3d'font-size: x-small;color: red'\x3e(\u9608\u503c\uff1a"+l+"-"+h+")\x3c/label\x3e"},xAxis:{type:"datetime",endOnTick:!0,showLastLabel:!1,labels:{format:"{value:%Y/%m/%d %H:%M:%S}",rotation:25,align:"left"}},yAxis:{plotLines:[{value:l,width:1,color:"red",zIndex:5,label:{text:"\u4e0b\u9650\u6807\u51c6: "+l,align:"center",style:{color:"red"}}},{value:h,width:1,color:"red",zIndex:5,label:{text:"\u4e0a\u9650\u6807\u51c6: "+h,align:"center",style:{color:"red"}}}]},tooltip:{crosshairs:[!0,!0],shared:!0,useHTML:!0,xDateFormat:"%Y/%m/%d %H:%M:%S"},rangeSelector:{inputDateFormat:"%Y/%m/%d",buttons:[{type:"all",text:"All"}]},series:[{name:E+"\u503c",type:a,zIndex:1,data:d,marker:{fillColor:"white",lineWidth:2,lineColor:Highcharts.getOptions().colors[0]}},{name:"\u8303\u56f4",data:e,type:"arearange",lineWidth:0,linkedTo:":previous",color:Highcharts.getOptions().colors[0],fillOpacity:.2,zIndex:0}]})}function O(a,d,e,b){a={elem:"#starthour",istime:a,isclear:!1,istoday:!1,format:b,issure:!1,start:d,max:e,choose:function(a){m=a}};m=a.start;return a}function P(a,d,e,b,c){a={elem:"#endhour",istime:a,isclear:!1,istoday:!1,format:c,issure:!1,start:d,min:e,max:b,choose:function(a){k=a}};k=a.start;return a}function D(a,d,e,b){var c="YYYY/MM/DD",f=!1;if("minute"==a||"minute10"==a||"hour"==a)c="YYYY/MM/DD hh:mm:ss",f=!0;d&&(O(f,laydate.now(-2),laydate.now(0),c),P(f,laydate.now(0),m,laydate.now(0),c));e&&laydate(O(f,m,laydate.now(0),c));b&&laydate(P(f,k,m,laydate.now(0),c));$("#starthour").val(m);$("#endhour").val(k)}function u(a){Q=(new Date).getTime();a&&(v=setInterval(function(){R=(new Date).getTime();6E5<=R-Q?(w.dialog("option","title","\u63d0\u793a\u4fe1\u606f"),$("#tip .tipright p").html("\u662f\u5426\u7ee7\u7eed\u76d1\u63a7\u5b9e\u65f6\u6570\u636e\uff01"),w.dialog("option","_button","overtime"),w.dialog("open")):K(E,3E4)},1E4),$(document).mousemove(function(){u(!1)}),$(document).click(function(){u(!1)}))}var w=$("#tip").dialog({autoOpen:!1,height:300,width:530,modal:!0,buttons:[{text:"\u662f",click:function(a){u(!1);w.dialog("close")},"class":"sure"},{text:"\u5426",click:function(){clearInterval(v);w.dialog("close")},"class":"cancel"}]}),v,Q=0,R=0;u(!0);D("hour",!0);$("#realtime").click(function(){clearInterval(v);u(!0);K(E)});$("#history").click(function(){clearInterval(v);J="line";$("#searchType option[value\x3d'hour']").attr("selected",!0);y()});$("#searchType").change(function(){var a=$("#searchType option:selected").val();"minute"==a||"minute10"==a?D("minute"):D("hour")});var k,m;$("#starthour").click(function(){var a=$("#searchType option:selected").val();"minute"==a||"minute10"==a?D("minute",!1,!0):D("hour",!1,!0);addLaydateListener()});$("#endhour").click(function(){var a=$("#searchType option:selected").val();"minute"==a||"minute10"==a?D("minute",!1,!1,!0):D("hour",!1,!1,!0);$("#laydate_ms span").click(function(){addLaydateListener()});$("#laydate_ys li").click(function(){addLaydateListener()});addLaydateListener()});$("#searchpng").click(function(){if(""==k||void 0==k)return alert("\u8bf7\u5148\u9009\u62e9\u65e5\u671f\u8303\u56f4\uff01"),!1;y()});$("#linechart").click(function(){J="line";y()});$("#columnchart").click(function(){J="column";y()});$("#backIndicator").click(function(){window.location.href=null!=M?"indicatorList.html":null!=G?"alarm.html":"indicatorMap.html"});(function(){$("#nowcontainer").highcharts("StockChart",{chart:{type:"scatter",events:{click:function(a){}}},xAxis:{minPadding:.2,maxPadding:.2,type:"datetime",endOnTick:!0,showLastLabel:!1,labels:{format:"{value:%m/%d %H:%M:%S}",rotation:25,align:"left"}},yAxis:{title:{text:"",rotation:0,margin:20},minPadding:.2,maxPadding:.2,plotLines:[{value:l,width:1,color:"red",zIndex:5,label:{text:"\u4e0b\u9650\u6807\u51c6: "+l,align:"center",style:{color:"red"}}},{value:h,color:"red",width:1,zIndex:5,label:{text:"\u4e0a\u9650\u6807\u51c6: "+h,align:"center",style:{color:"red"}}}]},tooltip:{headerFormat:'\x3cspan style\x3d"font-size:10px"\x3e{point.key}\x3c/span\x3e\x3ctable\x3e',pointFormat:'\x3ctr\x3e\x3ctd style\x3d"color:{series.color};padding:0"\x3e{series.name}: \x3c/td\x3e\x3ctd style\x3d"padding:0"\x3e\x3cb\x3e{point.y:.3f}\x3c/b\x3e\x3c/td\x3e\x3c/tr\x3e',footerFormat:"\x3c/table\x3e",shared:!0,useHTML:!0,xDateFormat:"%Y/%m/%d %H:%M:%S"},rangeSelector:{inputDateFormat:"%Y/%m/%d",buttons:[{type:"all",text:"All"}]},legend:{enabled:!1},exporting:{enabled:!1},plotOptions:{series:{lineWidth:1,point:{events:{click:function(){}}}}},series:[{name:"",data:[]}]})})();var a=getCookie("indicatordata"),M=getCookie("indicatorCurrentPage"),G=getCookie("alarmInfo"),E="",L="",h="",l="",N="",I="",H="",d=null,J="line";delCookie("indicatorCurrentPage");delCookie("alarmInfo");null!=M&&setCookie("backCurrentPage",M);if(void 0!=a&&""!=a){a=JSON.parse(a);H=void 0==a.devId?"":a.devId;E=void 0==a.family?"":a.family;L=void 0==a.unit?"":a.unit;N=void 0==a.name?"":a.name;null!=G?(I=void 0==a.uid?"":a.uid,h=void 0==a.dmax?"":a.dmax,l=void 0==a.dmin?"":a.dmin):(I=void 0==a.id?"":a.id,h=void 0==a.max?"":a.max,l=void 0==a.min?"":a.min);var d=void 0==a.selectedDate?"":a.selectedDate,a=void 0==a.factory?"":a.factory.name,e={};e.devId=H;e=JSON.parse(listdevice(e));if("success"==e.errCode&&0!=e.total){var S={};S.userId=e.deviceList[0].account.uid;e=JSON.parse(listuser(S));"success"==e.errCode&&$("#deviceProvider").text(e.accountList[0].org);$("#factoryName").text(a)}null!=d&&""!=d?(m=d,k=dataFormate((new Date(d)).getTime()+864E5,"yyyy/MM/dd"),$("#starthour").val(d),$("#endhour").val(k),$("#history").click()):K(E)}null!=G&&(d=JSON.parse(G),m=d.startTime,k=d.endTime,$("#starthour").val(m),$("#endhour").val(k),$("#history").click())});window.applicationCache.status==window.applicationCache.UPDATEREADY&&window.applicationCache.update();