/**
 * Created by admin on 2015/11/17.
 */$(function(){function D(b){z=$("#indicatorselect option:selected").text();var f=$("#nowcontainer").highcharts();f.series[0].name=z;f.setTitle({useHTML:!0,text:z});var e={};e.family=z;var a={},c={};a.max="2000";a.start="0";c.sort={asc:"time"};e=datanow(e,a,c);a=JSON.parse(e);e=a.time;if("success"==a.errCode){for(var a=a.poluList,c=a.length,d=0;d<c;d++){JSON.stringify(a[d]);var h=void 0==a[d].max?"":a[d].max,l=void 0==a[d].unit?"":a[d].unit,n=void 0==a[d].value?"":a[d].value,k=void 0==a[d].time?"":a[d].time,g=e-k;J=void 0==a[d].min?"":a[d].min;E=h;K=l;1==/^-?\d+(\.\d+)?$/.test(n)&&(3E4!=b||3E4==b&&6E4>=g)&&(h=[],h.push(k),h.push(n),f.series[0].addPoint(h))}""!=E&&void 0!=E&&f.setTitle({useHTML:!0,text:z+"("+K+")\x3cbr\x3e\x3clabel style\x3d'font-size: x-small;color: red'\x3e(\u9608\u503c\uff1a"+J+"-"+E+")\x3c/label\x3e"})}}function F(){var b={},f={},e={};b.max="2000";b.start="0";f.factory=L;var a={},c=$("#searchType option:selected").val(),d=new Date(r);a.end=(new Date(u)).getTime()+(864E5-1);"hour"==c&&(a.scale="hour",a.end-=864E5-1);"day"==c?a.scale="day":"month"==c?a.scale="month":"year"==c?a.scale="year":"minute"==c?(a.scale="minute",a.end-=864E5-1):"minute10"==c?(a.scale="minute10",a.end-=864E5-1):"all"==c&&(a.scale="all");d=new Date(d.getTime());a.start=d.getTime();f.time=a;f.all="yes";e.sort={asc:"time"};a=datahistory(f,b,e);a=JSON.parse(a);e=f=b=0;if("success"==a.errCode&&0!=a.total){var c=a.resultList,d=/^-?\d+(\.\d+)?$/,h;for(h in c)for(var l in c[h]){var n=c[h][l],k=void 0==c[h].day?"":c[h].day,g;for(g in n)if(void 0==n[g].dvalue){var x=void 0==n[g].values?"":n[g].values,m=void 0==n[g].family?"":n[g].family,p;for(p in x){var H=[],q=void 0==x[p].min?"":Number(x[p].min).toFixed(3),y=void 0==x[p].max?"":Number(x[p].max).toFixed(3),t=void 0==x[p].avg?"":Number(x[p].avg).toFixed(3),a=void 0==x[p].time?"":x[p].time,q=Number(q),y=Number(y),v=k.substring(0,4)+"/"+k.substring(4,6)+"/"+k.substring(6,8),a=new Date(v+" "+a);1==d.test(t)&&1==d.test(q)&&1==d.test(y)&&(0==e&&(f=y,b=q),e++,y>f&&(f=y),q<b&&(b=q),H.push(a.getTime()),H.push(Number(t)),null==w[m]&&(w[m]=[]),w[m].push(H))}}}}h=[];for(l in w)g={},p=w[l],p.sort(function(a,b){return a[0]-b[0]}),g.name=l,g.data=p,h.push(g);S(h)}function M(){$("#nowcontainer").highcharts("StockChart",{chart:{renderTo:"nowcontainer",type:"scatter",events:{click:function(b){}}},title:{text:""},subtitle:{text:""},xAxis:{minPadding:.2,maxPadding:.2,type:"datetime",endOnTick:!0,showLastLabel:!1,labels:{format:"{value:%m/%d %H:%M:%S}",rotation:25,align:"left"}},dataZoom:{show:!0,realtime:!0,start:50,end:100},yAxis:{title:{text:"",rotation:0,margin:20},minPadding:.2,maxPadding:.2,plotLines:[]},tooltip:{headerFormat:'\x3cspan style\x3d"font-size:10px"\x3e{point.key}\x3c/span\x3e\x3ctable\x3e',pointFormat:'\x3ctr\x3e\x3ctd style\x3d"color:{series.color};padding:0"\x3e{series.name}: \x3c/td\x3e\x3ctd style\x3d"padding:0"\x3e\x3cb\x3e{point.y:.3f}\x3c/b\x3e\x3c/td\x3e\x3c/tr\x3e',footerFormat:"\x3c/table\x3e",shared:!0,useHTML:!0,xDateFormat:"%Y/%m/%d %H:%M:%S"},legend:{enabled:!1},exporting:{enabled:!1},rangeSelector:{inputDateFormat:"%Y/%m/%d",buttons:[{type:"all",text:"All"}]},plotOptions:{series:{lineWidth:1,point:{events:{click:function(){}}}}},series:[{name:"",data:[]}]})}function S(b){$("#historycontainer").highcharts("StockChart",{rangeSelector:{selected:1},title:{useHTML:!0,text:v},xAxis:{type:"datetime",endOnTick:!0,showLastLabel:!1,labels:{format:"{value:%Y/%m/%d %H:%M:%S}",rotation:25,align:"left"}},tooltip:{crosshairs:[!0,!0],shared:!0,useHTML:!0,xDateFormat:"%Y/%m/%d %H:%M:%S"},rangeSelector:{inputDateFormat:"%Y/%m/%d",buttons:[{type:"all",text:"All"}]},series:b})}function N(b,f,e,a){b={elem:"#starthour",istime:b,isclear:!1,istoday:!1,format:a,issure:!1,start:f,max:e,choose:function(a){r=a}};r=b.start;return b}function O(b,f,e,a,c){b={elem:"#endhour",istime:b,isclear:!1,istoday:!1,format:c,issure:!1,start:f,min:e,max:a,choose:function(a){u=a}};u=b.start;return b}function t(b,f,e,a){var c="YYYY/MM/DD",d=!1;if("minute"==b||"minute10"==b||"hour"==b)c="YYYY/MM/DD hh:mm:ss",d=!0;f&&(N(d,laydate.now(-2),laydate.now(0),c),O(d,laydate.now(0),r,laydate.now(0),c));e&&laydate(N(d,r,laydate.now(0),c));a&&laydate(O(d,u,r,laydate.now(0),c));$("#starthour").val(r);$("#endhour").val(u)}function A(b){P=(new Date).getTime();b&&(B=setInterval(function(){Q=(new Date).getTime();6E5<=Q-P?(C.dialog("option","title","\u63d0\u793a\u4fe1\u606f"),$("#tip .tipright p").html("\u662f\u5426\u7ee7\u7eed\u76d1\u63a7\u5b9e\u65f6\u6570\u636e\uff01"),C.dialog("option","_button","overtime"),C.dialog("open")):D(3E4)},1E4),$(document).mousemove(function(){A(!1)}),$(document).click(function(){A(!1)}))}function T(b,f){$("#deviceAlarmTable tbody").empty();$("#deviceAlarmTable tbody").html("");var e={},a=[],c=0;e.org=b;e.orgId=f;var d=JSON.parse(listdevice(e));if("success"==d.errCode&&0!=d.total){var e={},h=d.deviceList,l=[],n={},d=0;""!=G?(n.start=G,n.end=I):(n.start=(new Date).getTime()-864E5,n.end=(new Date).getTime());n.space=18E4;for(var k in h){var g=JSON.stringify(h[k]),m=h[k].id,t=void 0==h[k].type?"":h[k].type,p=void 0==h[k].subs?"":h[k].subs;e[m]=g;var g={},r={};g.id=m;g.time=n;g.devType=t;a[c]=t;c++;r.find=g;l.push(r);for(var q in p){var g={},r={},u=p[q].pid,v=void 0==p[q].type?t:p[q].type;g.id=m;g.subId=u;g.time=n;g.devType=v;a[c]=v;c++;r.find=g;l.push(r)}}c={};c.multiFind=l;var c=JSON.parse(listhiststate(c)).multiResult,w;for(w in c)k=c[w],"success"==k.errCode&&(d++,q=k.resultList,k=k.id.split("|"),q=q[q.length-1].A,l=JSON.parse(e[k[0]]),l.lastTime=q,l.subId=k[1],e[k[0]]=JSON.stringify(l),U(d,e[k[0]],l.name,dataFormate(q,"yyyy/MM/dd HH:mm:ss"),k[1],a[w],l.org));0!=d&&(sorter.init("deviceAlarmTable",1),null!=getCookie("deviceAlarmBackCurrentPage")&&(sorter.transferToPage(Number(getCookie("deviceAlarmBackCurrentPage"))),delCookie("deviceAlarmBackCurrentPage")))}}function U(b,f,e,a,c,d,h){var l="detail"+b;$("#deviceAlarmTable tbody").append("\x3ctr id\x3d'app_"+b+"'\x3e\x3ctd style\x3d'display: none'\x3e"+f+"\x3c/td\x3e\x3ctd style\x3d'width: 6%'\x3e"+b+"\x3c/td\x3e\x3ctd\x3e"+e+"\x3c/td\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3ctd\x3e"+d+"\x3c/td\x3e\x3ctd\x3e"+dataFormate(a,"yyyy/MM/dd HH:mm:ss")+"\x3c/td\x3e\x3ctd\x3e"+h+"\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d'../devices/deviceAlarmDetail.html' class\x3d'tablelink'target\x3d'rightFrame' id\x3d'"+l+"'\x3e \u67e5\u770b\u8be6\u60c5\x3c/a\x3e\x3c/tr\x3e");$(document).on("click","#"+l,function(){var a=$(this).parent().parent().children("td").eq(0).text();setCookie("deviceAlarm",a);a={};a.startTime=startTime;a.endTime=endTime;setCookie("alarmInfo",JSON.stringify(a));setCookie("deviceAlarmCurrentPage",$("#currentpage").text())})}var C=$("#tip").dialog({autoOpen:!1,height:300,width:530,modal:!0,buttons:[{text:"\u662f",click:function(b){A(!1);C.dialog("close")},"class":"sure"},{text:"\u5426",click:function(){clearInterval(B);C.dialog("close")},"class":"cancel"}]}),B,P=0,Q=0;A(!0);t("hour",!0);$("#realtime").click(function(){clearInterval(B);A(!0);D()});$("#history").click(function(){clearInterval(B);$("#searchType option[value\x3d'hour']").attr("selected",!0);F()});$("#deviceAlarm").click(function(){clearInterval(B)});$("#searchType").change(function(){var b=$("#searchType option:selected").val();"minute"==b||"minute10"==b?t("minute"):t("hour")});var u,r;$("#starthour").click(function(){var b=$("#searchType option:selected").val();"minute"==b||"minute10"==b?t("minute",!1,!0):t("hour",!1,!0)});$("#endhour").click(function(){var b=$("#searchType option:selected").val();"minute"==b||"minute10"==b?t("minute",!1,!1,!0):t("hour",!1,!1,!0)});$("#searchpng").click(function(){if(""==u||void 0==u)return alert("\u8bf7\u5148\u9009\u62e9\u65e5\u671f\u8303\u56f4\uff01"),!1;F()});$("#linechart").click(function(){F()});$("#columnchart").click(function(){F()});$("#backIndicator").click(function(){});$("#indicatorselect").change(function(){M();D()});var w={},v="";(function(){var b=JSON.parse(polusourcedistkey("family"));if("success"==b.errCode&&0!=b.total){var b=b.resultList,f;for(f in b){var e=b[f].family;w[e]=[];v+=e+"/";$("\x3coption\x3e"+e+"\x3c/option\x3e").appendTo($("#indicatorselect"))}v=v.substr(0,v.length-1)}})();var m=JSON.parse(getCookie("siteDetail"));getCookie("indicatorCurrentPage");var E="",J="",z="",K="";if(void 0!=m&&""!=m){var G=void 0==m.startTime?"":m.startTime,I=void 0==m.endTime?"":m.endTime,R=void 0==m.name?"":m.name,L=void 0==m.id?"":m.id;""!=G&&""!=I?(r=G,u=I,$("#starthour").val(r),$("#endhour").val(u),$("#history").click()):(M(),D());$("#factoryName").text(R);sortOp("deviceAlarmTable","currentpage","pagelimit",5);T(R,L)}});var sorter=new TINY.table.sorter("sorter");window.applicationCache.status==window.applicationCache.UPDATEREADY&&window.applicationCache.update();