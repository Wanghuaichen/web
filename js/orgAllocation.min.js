/**
 * Created by admin on 2015/11/2.
 */$(function(){function t(a){for(var b in a)if(void 0!=a[b]){var c=JSON.parse(a[b]);l(b+1,c.id,a[b],c.name)}0!=$("#allOrg").length&&(allTableSorter.init("allOrg",0),allTableSorter.size(5))}function m(a,b,c){$("#userOrg tbody").append("\x3ctr id\x3d'app_"+a+"'\x3e\x3ctd style\x3d'display: none'\x3e"+b+"\x3c/td\x3e\x3ctd\x3e\x3cinput name\x3d'checkbox1' class\x3d'nosort' type\x3d'checkbox' id\x3d'checkbox_"+a+"'/\x3e\x3c/td\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3c/tr\x3e")}function l(a,b,c,d){$("#allOrg tbody").append("\x3ctr id\x3d'"+b+"'\x3e\x3ctd style\x3d'display: none'\x3e"+c+"\x3c/td\x3e\x3ctd\x3e\x3cinput name\x3d'checkbox2' class\x3d'nosort' type\x3d'checkbox' id\x3d'checkbox_"+a+"'/\x3e\x3c/td\x3e\x3ctd\x3e"+d+"\x3c/td\x3e\x3c/tr\x3e")}function u(){$("#userOrg tbody").empty();$("#userOrg tbody").html("");$("#allOrg tbody").empty();$("#allOrg tbody").html("");var a=$("#userlist option:selected").val();if(""!=a&&void 0!=a){var b=JSON.parse(a),a={},b=JSON.parse(resaccessList(b.id)),a=JSON.parse(JSON.stringify(q));if("success"==b.errCode){var c=b.resultList,d;for(d in c){var f=c[d],e=f.org,g=e.name,e=e.id;f.allocation=!0;m(d+1,JSON.stringify(f),g);void 0!=a[e]&&(a[e]=void 0)}0!=b.total&&(sorter.init("userOrg",0),sorter.size(5))}t(a)}else t(q)}function v(){$("#userlist").empty();var a=$("#orglist option:selected").val().trim(),b={};b.orgId=a;a=JSON.parse(listuser(b));if("success"==a.errCode)for(a=a.accountList,b=0;b<a.length;b++){var c=a[b].userName;$("\x3coption value\x3d"+JSON.stringify(a[b]).replace(" ","")+"\x3e"+c+"\x3c/option\x3e").appendTo($("#userlist"))}u()}function n(a,b){var c=$("#userlist option:selected").val();if(""!=c&&void 0!=c){JSON.parse(c);for(c=0;c<b.length;c++){var d=JSON.parse(b[c]);if(void 0==d.allocation)"left"==a?m(c+1,b[c],d.name):l(c+1,d.id,b[c],d.name);else{var f=d.org;"left"==a?m(c+1,b[c],f.name):(p.push(d),l(c+1,d.id,b[c],f.name))}}sorter.init("userOrg",0);sorter.size(5);allTableSorter.init("allOrg",0);allTableSorter.size(5)}else{alert("\u5f53\u524d\u6ca1\u6709\u9009\u62e9\u4efb\u4f55\u7528\u6237\u4fe1\u606f\uff01");for(c=0;c<b.length;c++){var d=c+1,f=b[c],e=JSON.parse(f).appName;"left"==a?l(d,f,e):m(d,f,e)}return!1}}$("#checkAll1").click(function(){$(this).is(":checked")?$("input[name\x3d'checkbox1']").each(function(){$(this).prop("checked",!0)}):$("input[name\x3d'checkbox1']").each(function(){$(this).prop("checked",!1)})});$("#checkAll2").click(function(){$(this).is(":checked")?$("input[name\x3d'checkbox2']").each(function(){$(this).prop("checked",!0)}):$("input[name\x3d'checkbox2']").each(function(){$(this).prop("checked",!1)})});var r=$("#funcDialog").dialog({autoOpen:!1,height:350,width:530,modal:!0,buttons:[{text:"\u63d0\u4ea4",click:function(){var a,b="",c=[];$("#funcTable tbody tr").each(function(){a=$(this).children("td").eq(0).text();var d=$(this).children("td").eq(2).text();b+=d+"|";var e="";$(this).children("td").children("input").each(function(){if($(this).is(":checked")){var a=$(this).val();e+=a+"|"}});var g={};g[d]=e.substring(0,e.length-1);c.push(g)});var d=$("#userlist option:selected").val(),d=JSON.parse(d);"success"!=("true"==r.dialog("option","update")?JSON.parse(updateuserperm(d.id,a,b.substring(0,b.length-1),c)):JSON.parse(createuserperm(d.id,a,b,c))).errCode&&alert("\u4fee\u6539\u7528\u6237\u5e94\u7528\u6743\u9650\u5931\u8d25\uff01");r.dialog("close")},"class":"sure",id:"funcsure"},{text:"\u5173\u95ed",click:function(){r.dialog("close")},"class":"cancel"}]});$("#orglist").change(function(){v()});$("#userlist").change(function(){u()});$("#btnLeftAll").click(function(){var a=$("#userlist option:selected").val();if(""==a||void 0==a)alert("\u5f53\u524d\u6ca1\u6709\u9009\u62e9\u4efb\u4f55\u7528\u6237\u4fe1\u606f\uff01");else{var b=[];$("input[type\x3dcheckbox][name\x3dcheckbox2]").each(function(){var a=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();b.push(a)});n("left",b)}});$("#btnLeft").click(function(){var a=$("#userlist option:selected").val();if(""==a||void 0==a)alert("\u5f53\u524d\u6ca1\u6709\u9009\u62e9\u4efb\u4f55\u7528\u6237\u4fe1\u606f\uff01");else{var b=[];$("input[type\x3dcheckbox][name\x3dcheckbox2]:checked").each(function(){var a=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();b.push(a)});n("left",b)}});$("#btnRight").click(function(){var a=[];$("input[type\x3dcheckbox][name\x3dcheckbox1]:checked").each(function(){var b=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();a.push(b)});n("right",a)});$("#btnRightAll").click(function(){var a=[];$("input[type\x3dcheckbox][name\x3dcheckbox1]").each(function(){var b=$(this).parent().parent().children("td").eq(0).text();$(this).parent().parent().remove();a.push(b)});n("right",a)});$("#submit").click(function(){var a=$("#userlist option:selected").val();if(""==a||void 0==a)alert("\u5f53\u524d\u6ca1\u6709\u9009\u62e9\u4efb\u4f55\u7528\u6237\u4fe1\u606f\uff01");else{var b=JSON.parse(a),c=[];$("#userOrg tbody tr").each(function(){var a=$(this).children().eq(0).text(),a=JSON.parse(a),d={},g={},h={},k=[];void 0==a.allocation&&(d.uid=b.id,d.name=b.userName,g.user=d,h.uId=a.id,h.name=a.name,k.push("all"),g.org=h,g.mgroups=k,c.push(g),g=JSON.parse(resaccessCreate(c)),"success"==g.errCode?(h={},k={},k.id=a.id,k.name=a.name,h.id=g.id,h.user=d,h.org=k,h.allocation=!0,$(this).children().eq(0).text(JSON.stringify(h))):($(this).remove(),l(0,a.id,JSON.stringify(a),a.name)))});for(var d in p)a=p[d],"success"!=JSON.parse(resaccessDelete(a.id)).errCode&&(m(0,p[d],a.org.name),$("#"+a.id).remove());sorter.init("userOrg",0);sorter.size(5);allTableSorter.init("allOrg",0);allTableSorter.size(5)}});var q={},p=[];(function(){var a=JSON.parse(listorg({all:""}));if("success"==a.errCode){for(var a=a.orgList,b=0;b<a.length;b++){var c=JSON.stringify(a[b]),d=a[b].id,f=a[b].name;q[d]=c;$("\x3coption value\x3d"+d+"\x3e"+f+"\x3c/option\x3e").appendTo($("#orglist"))}v()}})()});