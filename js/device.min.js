$(function(){function G(a){$("#deviceTable tbody").empty();$("#deviceTable tbody").html("");a=listdevice(a);v=JSON.parse(a);if("success"==v.errCode&&0!=v.total){a=v.deviceList;for(var b=a.length,c=0;c<b;c++){var f=JSON.stringify(a[c]),d=a[c].name,h=a[c].devId,e=void 0==a[c].org?"":a[c].org,g=void 0==a[c].account?"":a[c].account.name,p=void 0==a[c].state?"":a[c].state,k=void 0==a[c].desc?"":a[c].desc,q=void 0==a[c].connState?"":a[c].connState,l=void 0==a[c].code?"":a[c].code;H=a[c].type;E(c+1,f,h,d,l,H,q,e,g,p,k)}sorter.init("deviceTable",2);null!=getCookie("backCurrentPage")&&(sorter.transferToPage(Number(getCookie("backCurrentPage"))),delCookie("backCurrentPage"))}}function E(a,b,c,f,d,h,e,g,p,k,q){p="detail"+a;k="\x3ctd\x3e\x3c/td\x3e";if("on"==e.main){k="\x3cimg src\x3d'../images/status_ok.min.png'\x3e ";e=e.subs;for(var l in e)k="on"==e[l]?k+"\x3cimg src\x3d'../images/status_ok.min.png'\x3e ":k+"\x3cimg src\x3d'../images/status_err.min.png'\x3e "}else k="\x3cimg src\x3d'../images/status_err.min.png'\x3e";k="\x3ctd\x3e"+k+"\x3c/td\x3e";$("#deviceTable tbody").append("\x3ctr id\x3d'device_"+a+"'\x3e\x3ctd style\x3d'display: none'\x3e"+b+"\x3c/td\x3e\x3ctd style\x3d'width: 4%'\x3e\x3cinput name\x3d'checkbox' class\x3d'nosort' type\x3d'checkbox' id\x3d'checkbox_"+a+"'/\x3e\x3c/td\x3e\x3ctd style\x3d'width: 6%'\x3e"+a+"\x3c/td\x3e\x3ctd\x3e"+f+"\x3c/td\x3e\x3ctd\x3e"+c+"\x3c/td\x3e\x3ctd\x3e"+d+"\x3c/td\x3e\x3ctd\x3e"+h+"\x3c/td\x3e"+k+"\x3ctd\x3e"+g+"\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d'../devices/checkDeviceDetail.html' target\x3d'rightFrame' class\x3d'tablelink' id\x3d'"+p+"'\x3e\u8be6\u60c5\x3c/a\x3e \x3ca href\x3d'javascript:void(0)' class\x3d'delUser tablelink'\x3e \u5220\u9664\x3c/a\x3e\x3c/td\x3e\x3c/tr\x3e");$(document).on("click","#"+p,function(){var a=$(this).parent().parent().children("td").eq(0).text();setCookie("deviceselected",a);setCookie("deviceCurrentPage",$("#currentpage").text())})}function K(){var a=$("#add-device").dialog("option","title"),b=$("#deviceName").val().trim(),c=$("#deviceId").val().trim().replace(/\s{1,}/g,""),f=$("#checkCode").val().trim(),d=$("#factorylist option:selected").val(),h=$("#boxType option:selected").text(),e=$("#des").val().trim(),g=$("#cardNum").val().trim(),p=$("#cardExpire").val().trim(),k=$("#k37sn").val().trim(),q=$("input[name\x3dradio]:checked").val();if(""==b)return $(".confirmMsg").html("\u8bbe\u5907\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a\uff01"),!1;if(""==c||!/^\d+$/.test(c)||16>c.length)return $(".confirmMsg").html("\u8bf7\u6b63\u786e\u8f93\u5165\u8bbe\u5907id\uff0c\u683c\u5f0f\u4e3a16\u4f4d\u6570\u5b57\uff01"),!1;if(""==f||4>f.length)return $(".confirmMsg").html("\u8bf7\u6b63\u786e\u8f93\u5165\u9a8c\u8bc1\u7801\uff0c\u683c\u5f0f\u4e3a4\u4f4d\u6570\u5b57\u6216\u5b57\u6bcd\uff01"),!1;if(""==d)return $(".confirmMsg").html("\u8bf7\u9009\u62e9\u5de5\u5382\u4fe1\u606f\uff0c\u5982\u679c\u6ca1\u6709\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458\u6dfb\u52a0\uff01"),!1;if(""==e)return $(".confirmMsg").html("\u63cf\u8ff0\u4fe1\u606f\u4e0d\u80fd\u4e3a\u7a7a\uff01"),!1;if("cywee-c801"==h||"cywee-c802"==h){if(""==g)return $(".confirmMsg").html("\u5361\u53f7\u4fe1\u606f\u4e0d\u80fd\u4e3a\u7a7a\uff01"),!1;if(""==p)return $(".confirmMsg").html("\u5361\u53f7\u8fc7\u671f\u65f6\u95f4\u4fe1\u606f\u4e0d\u80fd\u4e3a\u7a7a\uff01"),!1;var l=p.match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/);if(null==l)return $(".confirmMsg").html("\u5361\u53f7\u8fc7\u671f\u65f6\u95f4\u683c\u5f0f\u4e0d\u6b63\u786e\uff01"),!1;var m=new Date(l[1],l[3]-1,l[4]);if(m.getFullYear()!=l[1]||m.getMonth()+1!=l[3]||m.getDate()!=l[4])return $(".confirmMsg").html("\u5361\u53f7\u8fc7\u671f\u65f6\u95f4\u4e0d\u7b26\u5408\u65e5\u671f\u89c4\u8303,\u6708\uff1a1-12\uff0c\u5929\uff1a1-31\uff01"),!1;l={};l.number=g;l.expire=p}var B=[],v=!0;$("tr[class^\x3d'sub']").each(function(){var a=$(this).children("td").eq(1).children().val().trim().replace(/\s{1,}/g,""),b=$(this).children("td").eq(3).children().val().trim(),c=$(this).children("td").eq(3).children().eq(1).find("option:selected").text();if(""!=a&&""!=b||""==a&&""==b){if(""==a&&""==b)return!0;var d=Gen_Checksum(a,a.length);if(d!=b)return console.log("\u6b63\u786e\u9a8c\u8bc1\u7801\x3d"+d),$(".confirmMsg").html("\u5b50\u8bbe\u5907Id\uff1a"+a+"\u7684\u9a8c\u8bc1\u7801\u8f93\u5165\u6709\u8bef\uff01"),v=!1;d={};d.pid=a;d.code=b;d.type=c;B.push(d)}else return $(".confirmMsg").html("\u5b50\u8bbe\u5907\u7684Id "+a+"\u548c\u5bf9\u5e94\u8ba4\u8bc1\u7801 "+b+"\u4e0d\u80fd\u540c\u65f6\u4e3a\u7a7a\uff0c\u9700\u4e00\u4e00\u5bf9\u5e94\uff01"),v=!1});if(!v)return B=[],!1;m=Gen_Checksum(c,c.length);if(m!=f)return console.log("\u6b63\u786e\u9a8c\u8bc1\u7801\x3d"+m),$(".confirmMsg").html("\u8bbe\u5907\u9a8c\u8bc1\u7801\u8f93\u5165\u6709\u8bef\uff01"),!1;var t=JSON.parse(d),d={};d.province=t.location.province;d.city=t.location.city;d.district=t.location.district;d.address=t.location.address;d.lnt=void 0==t.location.lnt?"":t.location.lnt;d.lat=void 0==t.location.lat?"":t.location.lat;var n={};n.code=f;n.state=q;n.desc=e;n.org=t.name;n.orgId=t.id;n.location=d;n.wcard=l;0!=B.length&&(n.subs=B);n.type=h;""!=k&&(n.k37sn=k);if("\u6dfb\u52a0\u8bbe\u5907"==a)if(g=createdevice(c,b,n),g=JSON.parse(g),"success"==g.errCode)n.id=g.id,n.name=b,n.devId=c,n.creator=u.id,g=JSON.stringify(n),p=$("#deviceTable tbody tr").length+1,E(p,g,c,b,f,h,"",t.name,"",q,e);else return $(".confirmMsg").html("\u521b\u5efa\u8bbe\u5907\u5931\u8d25\uff0c"+(void 0==r[g.errCode]?g.errCode:r[g.errCode])+"!"),!1;else{n.name=b;n.devId=c;var a=JSON.parse($("input[type\x3dcheckbox][name\x3dcheckbox]:checked").parent().parent().children("td").eq(0).text()),m={},w=void 0==a.devId?"":a.devId,x=void 0==a.org?"":a.org,y=void 0==a.desc?"":a.desc,z=void 0==a.state?"":a.state,A=void 0==a.k37sn?"":a.k37sn,C=void 0==a.subs?"":a.subs,D=void 0==a.type?"":a.type,F=void 0==a.wcard?"":a.wcard;b!=(void 0==a.name?"":a.name)&&(m.name=b);c!=w&&(m.devId=c,m.code=f);t.name!=x&&(m.org=t.name,m.orgId=t.id,m.location=d);e!=y&&(m.desc=e);q!=z&&(m.state=q);k!=A&&(m.k37sn=k);B!=C&&(m.subs=B);h!=D&&(m.type=h);if(""==F||g!=F.number||p!=F.expire)m.wcard=l;e=JSON.parse(updatedevice(a.id,m));if("success"==e.errCode)n.id=a.id,$("input[type\x3dcheckbox][name\x3dcheckbox]:checked").each(function(){var a=$(this).parent().parent().attr("id");$("tr[id\x3d'"+a+"']").children("td").eq(0).text(JSON.stringify(n));$("tr[id\x3d'"+a+"']").children("td").eq(3).text(b);$("tr[id\x3d'"+a+"']").children("td").eq(4).text(c);$("tr[id\x3d'"+a+"']").children("td").eq(5).text(f);$("tr[id\x3d'"+a+"']").children("td").eq(6).text(h);$("tr[id\x3d'"+a+"']").children("td").eq(8).text(t.name)});else return $(".confirmMsg").html("\u4fee\u6539\u8bbe\u5907\u4fe1\u606f\u5931\u8d25\uff0c"+(void 0==r[e.errCode]?e.errCode:r[e.errCode])+"!"),!1}}function L(a){a.each(function(){var a=JSON.parse($(this).parent().parent().children("td").eq(0).text()),c=void 0==a.name?"":a.name,f=void 0==a.type?"":a.type,d=void 0==a.devId?"":a.devId,h=void 0==a.code?"":a.code,e=void 0==a.org?"":a.org,g=void 0==a.desc?"":a.desc,p=void 0==a.state?"":a.state,k=void 0==a.k37sn?"":a.k37sn,q=void 0==a.subs?"":a.subs;void 0!=a.wcard&&(a=a.wcard,$("#cardNum").val(void 0==a.number?"":a.number),$("#cardExpire").val(void 0==a.expire?"":a.expire));$("#deviceName").val(c);$("#deviceId").val(d);$("#checkCode").val(h);$("#k37sn").val(k);$("#factorylist option").each(function(){$(this).text()==e&&$(this).attr("selected",!0)});$("#boxType option").each(function(){var a=$(this).text();f==a&&$(this).attr("selected",!0)});$("#des").val(g);if(""!=q)for(c=0;c<q.length;c++){d=c+1;h=q[c].pid;g=q[c].code;k=void 0==q[c].type?"":q[c].type;$("#plcId"+d).val(h);$("#plcCheckCode"+d).val(g);var l="plcId"+d;$("#addSubDevice").parent().parent().before("\x3ctr class\x3d'sub"+d+"'\x3e\x3ctd class\x3d'deviceeven'\x3e\x3clabel\x3e\u5b50\u8bbe\u5907Id\x3c/label\x3e\x3c/td\x3e\x3ctd class\x3d'deviceodd'\x3e\x3cinput type\x3d'text' class\x3d'dfinput tinput' placeholder\x3d'\u5b50\u8bbe\u5907Id' value\x3d'"+h+"' id\x3d'"+l+"' maxlength\x3d'19' min\x3d'19'/\x3e\x3c/td\x3e\x3ctd class\x3d'deviceeven'\x3e\x3clabel\x3e\u5b50\u8bbe\u5907\u8ba4\u8bc1\u7801\x3c/label\x3e\x3c/td\x3e\x3ctd class\x3d'deviceodd'\x3e\x3cinput type\x3d'text' class\x3d'dfinput tinput' placeholder\x3d'\u5b50\u8bbe\u5907\u8ba4\u8bc1\u7801' value\x3d'"+g+"' id\x3d'plcCheckCode"+d+"'maxlength\x3d'4' min\x3d'4' style\x3d'width:125px'/\x3e"+D(!0,"subType"+d,k)+"\x3cdiv class\x3d'deviceSubs plc"+d+" minus'\x3e\x3cimg src\x3d'../images/-.min.png' style\x3d'vertical-align:middle;'\x3e\x3c/div\x3e\x3c/td\x3e\x3c/tr\x3e");$("#"+l).keyup(function(){test(l)})}$("input[name\x3dradio][value\x3d"+p+"]").val()})}function D(a,b,c){if("success"==I.errCode){var f=I.resultList;if(a){a="";for(var d in f){var h=JSON.stringify(f[d]),e=f[d].type;a=null!=c&&c==e?a+("\x3coption value\x3d'"+h.replace(/\s/g,"")+"' selected\x3e"+e+"\x3c/option\x3e"):a+("\x3coption value\x3d'"+h.replace(/\s/g,"")+"'\x3e"+e+"\x3c/option\x3e")}return"\x3cselect class\x3d'select' id\x3d'"+b+"' style\x3d'width: 110px;height: 33px;display: inline;margin-left: 10px'\x3e"+a+"\x3c/select\x3e"}$("#boxType").empty();for(d in f)h=JSON.stringify(f[d]),e=f[d].type,$("\x3coption value\x3d"+h.replace(/\s/g,"")+"\x3e"+e+"\x3c/option\x3e").appendTo($("#boxType"))}else if(a)return"\x3cselect class\x3d'select' id\x3d'"+b+"' style\x3d'width: 110px;height: 33px;display: inline;margin-left: 10px'\x3e\x3c/select\x3e"}function M(){$(".confirmMsg").html("");$("#deviceName").val("");$("#deviceId").val("");$("#checkCode").val("");$("#cardNum").val("");$("#cardExpire").val("");$("#des").val("");$("#orglist option:first").prop("selected","selected");$("#factorylist option:first").prop("selected","selected");$("#userlist").empty();$("tr[class^\x3d'sub']").each(function(){$(this).remove()})}$("#checkAll").click(function(){$(this).is(":checked")?$("input[name\x3d'checkbox']").each(function(){$(this).prop("checked",!0)}):$("input[name\x3d'checkbox']").each(function(){$(this).prop("checked",!1)})});var w,C,x,u,H=null,r={},J=$(".validateTips");r.devIdExisted="\u8bbe\u5907Id\u5df2\u7ecf\u5b58\u5728";r.failed="failed";r.paramErr="paramErr";r.jsonErr="jsonErr";r.optionJsonErr="optionJsonErr";r.devNotExist="devNotExist";r.updateNothing="updateNothing";r.noListPerm="noListPerm";r.noItem="noItem";r.newDevIdSameWithOld="newDevIdSameWithOld";w=$("#add-device").dialog({autoOpen:!1,height:480,width:780,modal:!0,buttons:[{text:"\u786e\u5b9a",click:function(){0!=K()&&w.dialog("close")},"class":"sure"},{text:"\u53d6\u6d88",click:function(){w.dialog("close")},"class":"cancel"}],close:function(a,b){M()}});C=$("#tip").dialog({autoOpen:!1,height:300,width:530,modal:!0,buttons:[{text:"\u786e\u5b9a",click:function(){C.dialog("close")},"class":"sure"}]});x=$("#deltip").dialog({autoOpen:!1,height:300,width:530,modal:!0,buttons:[{text:"\u786e\u5b9a",click:function(a){a=$(this).dialog("option","_button");x.dialog("close");if("del"==a)$("input[type\x3dcheckbox][name\x3dcheckbox]:checked").each(function(){if("checkAll"==$(this).attr("id"))return!0;var a=JSON.parse($(this).parent().parent().children("td").eq(0).text());"success"==JSON.parse(deletedevice(a.id)).errCode?$(this).parent().parent().remove():alert("\u5220\u9664\u8bbe\u5907"+a.name+"\u5931\u8d25\uff01")});else{var b=JSON.parse(a.parent().parent().children("td").eq(0).text());"success"==JSON.parse(deletedevice(b.id)).errCode?a.parent().parent().remove():alert("\u5220\u9664"+b.name+"\u5931\u8d25\uff01")}},"class":"sure"},{text:"\u53d6\u6d88",click:function(){x.dialog("close")},"class":"cancel"}]});$(".add").click(function(){w.dialog("open");w.dialog({title:"\u6dfb\u52a0\u8bbe\u5907"});J.text("\u6dfb\u52a0\u8bbe\u5907\u4fe1\u606f");$("#boxType").change()});$(".update").click(function(){$(".confirmMsg").html("");var a=$("input[type\x3dcheckbox][name\x3dcheckbox]:checked").length;0!=a&&1==a?(a=$("input[type\x3dcheckbox][name\x3dcheckbox]:checked"),L(a),w.dialog("open"),w.dialog({title:"\u4fee\u6539\u8bbe\u5907"}),J.text("\u4fee\u6539\u8bbe\u5907\u4fe1\u606f"),$("#boxType").change()):C.dialog("open")});$(".del").click(function(){0==$("input[type\x3dcheckbox][name\x3dcheckbox]:checked").length?C.dialog("open"):(x.dialog("option","_button","del"),x.dialog("open"))});$(document).on("click",".delUser",function(){x.dialog("option","_button",$(this));x.dialog("open")});$(document).on("click",".deviceSubs",function(){var a=$(this).attr("class").split(" "),b=$("tr[class^\x3d'sub']").length;if(2<a.length)if("addSub"==a[2]){b++;var c="plcId"+b;$(this).parent().parent().before("\x3ctr class\x3d'sub"+b+"'\x3e\x3ctd class\x3d'deviceeven'\x3e\x3clabel\x3e\u5b50\u8bbe\u5907Id\x3c/label\x3e\x3c/td\x3e\x3ctd class\x3d'deviceodd'\x3e\x3cinput type\x3d'text' class\x3d'dfinput tinput' placeholder\x3d'\u5b50\u8bbe\u5907Id' id\x3d'"+c+"' maxlength\x3d'19' min\x3d'19'/\x3e\x3c/td\x3e\x3ctd class\x3d'deviceeven'\x3e\x3clabel\x3e\u5b50\u8bbe\u5907\u8ba4\u8bc1\u7801\x3c/label\x3e\x3c/td\x3e\x3ctd class\x3d'deviceodd'\x3e\x3cinput type\x3d'text' class\x3d'dfinput' placeholder\x3d'\u5b50\u8bbe\u5907\u8ba4\u8bc1\u7801' id\x3d'plcCheckCode"+b+"' maxlength\x3d'4' min\x3d'4' style\x3d'width:125px'/\x3e"+D(!0,"subType"+b)+"\x3cdiv class\x3d'deviceSubs plc minus'\x3e\x3cimg src\x3d'../images/-.min.png' style\x3d'vertical-align:middle;'\x3e\x3c/div\x3e\x3c/td\x3e\x3c/tr\x3e");$("#"+c).keyup(function(){test(c)})}else $(this).parent().parent().remove()});$("#searchType").change(function(){var a=$("#searchType option:selected").val();"all"==a?($("#searchByName").css("display","none"),$("#searchById").css("display","none")):"deviceName"==a?($("#searchByName").css("display","inline"),$("#searchByName").val(""),$("#searchById").css("display","none")):"deviceId"==a&&($("#searchByName").css("display","none"),$("#searchById").css("display","inline"),$("#searchById").val(""))});$("#boxType").change(function(){var a=$(this).find("option:selected").text();"cywee-c801"==a||"cywee-c802"==a?($(".SIMtr").css("display",""),$(".k37tr").css("display","")):($(".SIMtr").css("display","none"),$(".k37tr").css("display","none"))});$("#searchpng").click(function(){var a={},b=$("#searchType option:selected").val();if("all"==b)a.all="",G(a);else{if("deviceName"==b){b=$("#searchByName").val().trim();if(""==b)return alert("\u8bbe\u5907\u540d\u79f0\u4e0d\u80fd\u4e3a\u7a7a\uff01"),!1;a.name=b}else if("deviceId"==b){b=$("#searchById").val().trim();if(""==b)return alert("\u8bbe\u5907Id\u4e0d\u80fd\u4e3a\u7a7a\uff01"),!1;a.devId=b}$("#deviceTable tbody").empty();$("#deviceTable tbody").html("");if(null!=v&&"success"==v.errCode){for(var b=v.deviceList,c=b.length,f=0,d=0;d<c;d++){var h=JSON.stringify(b[d]),e=b[d].name,g=b[d].devId,p=void 0==b[d].org?"":b[d].org,k=void 0==b[d].account?"":b[d].account.name,q=void 0==b[d].state?"":b[d].state,l=void 0==b[d].desc?"":b[d].desc,m=void 0==b[d].connState?"":b[d].connState,r=void 0==b[d].code?"":b[d].code,u=b[d].type;if(""==a.name||(new RegExp(a.name)).test(e))if(""==a.devId||(new RegExp(a.devId)).test(g))f++,E(f,h,g,e,r,u,m,p,k,q,l)}sorter.init("deviceTable",2)}}});var z=getCookie("userInfo"),v,A={};console.log("cookie\x3d"+z);u=JSON.parse(z).account;"superr"==u.type||"root"==u.type?A.all="":A.orgId=u.orgId;var I=JSON.parse(devtypeList(A)),z={};"root"==u.type||"superr"==u.type?z.all="":(A={},A.name=u.userName,z.account=A);G(z);(function(){var a=listorg({type:"factory"}),a=JSON.parse(a);if("success"==a.errCode)for(var a=a.orgList,b=0;b<a.length;b++){var c=JSON.stringify(a[b]),f=a[b].name;$("\x3coption value\x3d"+c.replace(/\s/g,"")+"\x3e"+f+"\x3c/option\x3e").appendTo($("#factorylist"))}a={all:""};a.orgId=u.orgId;a=listorg(a);a=JSON.parse(a);if("success"==a.errCode)for(a=a.orgList,b=0;b<a.length;b++)"\u5de5\u5382"!=a[b].type&&(c=a[b].id,f=a[b].name,$("\x3coption value\x3d"+c+"\x3e"+f+"\x3c/option\x3e").appendTo($("#orglist")))})();D(!1,"","");"root"!=u.type&&"superr"!=u.type&&"admin"!=u.type?($(".add").css("display","none"),$(".update").css("display","none"),$(".del").css("display","none")):($(".add").css("display","inline"),$(".update").css("display","inline"),$(".del").css("display","inline"));var y=[];y.push("search1");y.push("search2");y.push("search3");setup(y);$("#search1").change(function(){change(1,y)});$("#search2").change(function(){change(2,y)});$("#search3").change(function(){change(3,y)})});