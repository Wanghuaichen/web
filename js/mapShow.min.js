/**
 * Created by admin on 2015/12/25.
 */$(document).ready(function(){function w(){r.clearOverlays();var a=document.getElementById("search1"),b=document.getElementById("search2"),a=a.options[a.selectedIndex].value,b=b.options[b.selectedIndex].value,c={};"\u7701\u4efd"!=a?(c.province=a,r.centerAndZoom(a,6),"\u5730\u7ea7\u5e02"!=b&&(c.city=b)):c=null;a={};null!=c&&(a.location=c);b={};c={};b.max="2000";b.start="0";c.filter={};var e=null;if(null!=selectDate){var e=new Date(selectDate),f={scale:"day"};f.start=e.getTime();f.end=e.getTime()+(864E5-1);a.time=f;a.all="yes";e=JSON.parse(datahistory(a,b,c))}else e=JSON.parse(datanow(a,b,c));if("success"==e.errCode){a=null;t={};u={};if(void 0==e.poluList){var a=e.resultList,l;for(l in a){var b=a[l].dayResult,g;for(g in b){b[g].selectedDate=selectDate;b[g].id=b[g].uid;var c=JSON.stringify(b[g]),h=void 0==b[g].factory.name?"":b[g].factory.name;if(void 0==t[h]||null==t[h])t[h]=[];t[h].push(c)}}}else for(l in a=e.poluList,a){c=JSON.stringify(a[l]);h=void 0==a[l].factory.name?"":a[l].factory.name;if(void 0==t[h]||null==t[h])t[h]=[];t[h].push(c)}for(l in t){var h=l,k=null,q=null,e=c=b=a=null,n=0,m=t[l],f={};for(g in m){var d=JSON.parse(m[g]);"0"==g&&(k=void 0==d.location.lnt?"":d.location.lnt,q=void 0==d.location.lat?"":d.location.lat,a=void 0==d.location.province?"":d.location.province,b=void 0==d.location.city?"":d.location.city,c=void 0==d.location.district?"":d.location.district,e=void 0==d.location.address?"":d.location.address);var p=void 0==d.lower?"":d.lower;"yes"!=(void 0==d.higher?"":d.higher)&&"yes"!=p||n++;var p=d.family,y=d.value;if(void 0==y){var d=d.values,C;for(C in d)y=Number(d[C].avg)}null==f[p]&&(f[p]={},f[p].value=0,f[p].count=0,f[p].max=0);y>f[p].max&&(f[p].max=y);f[p].value+=y;f[p].count++}for(var x in f)null==u[x]&&(u[x]=[]),m={},m.name=h,m.value=f[x].value,m.max=f[x].max,m.count=f[x].count,u[x].push(m);""!=k&&""!=q?v(k,q,h,n,!0):(f=new BMap.LocalSearch(r),f.enableAutoViewport(),f.setSearchCompleteCallback(function(a){a=a.getPoi(0);k=a.point.lng;q=a.point.lat;v(k,q,h,n,!0)}),f.search(a+b+c+e))}}else u=null;D();$("#usual ul").idTabs()}function v(a,b,c,e,f){var l="",l=f?c:c.name;f=null;var g=new BMap.Label(l,{offset:new BMap.Size(20,-10)});g.setStyle({display:"none"});0!=e?(f=new BMap.Icon("../images/redMarker.png",new BMap.Size(25,25)),g.setStyle({color:"red",fontSize:"18px",height:"30px",lineHeight:"30px",border:"red",fontFamily:"\u5fae\u8f6f\u96c5\u9ed1"})):(f=new BMap.Icon("../images/greenMarker.png",new BMap.Size(25,25)),g.setStyle({color:"green",fontSize:"12px",height:"20px",lineHeight:"20px",border:"green",fontFamily:"\u5fae\u8f6f\u96c5\u9ed1"}));a=new BMap.Marker(new BMap.Point(a,b),{icon:f});a.addEventListener("click",function(){var a=E(c,e);this.openInfoWindow(a.infoWindow);setTimeout(function(){$("#"+a.alarmId).on("click",function(){leftmenuclick()});$("#"+a.siteId).on("click",function(){var a=JSON.parse(t[c][0]),b={};if(null!=selectDate){var e=(new Date(selectDate)).getTime()-864E5;b.startTime=dataFormate(e,"yyyy/MM/dd");b.endTime=selectDate}b.name=a.factory.name;b.id=a.factory.id;setCookie("siteDetail",JSON.stringify(b))})},10)});a.addEventListener("mouseover",function(){g.setStyle({display:"block"})});a.addEventListener("mouseout",function(){g.setStyle({display:"none"})});a.setLabel(g);r.addOverlay(a)}function E(a,b){var c="",e=Math.floor(1E5*Math.random()),f="manualIndicatorT"+e,l="currentPage"+e,g="pageList"+e,h="alarm"+e,e="site"+e,k="\x3cdiv class\x3d'siteContentWindow borderRadius'\x3e\x3cdiv style\x3d'float: left;  border-right: 1px solid lightgrey;width: 50%;min-height: 120px'\x3e",c=a,q=t[a],n;for(n in q){var m=q[n],d=JSON.parse(q[n]),p=parseInt(n)+1,r=d.name,p="detail"+p,u=d.unit,x=void 0==d.higher?"":d.higher,w=void 0==d.lower?"":d.lower,v=null;void 0==d.value?(d=d.values[0],v=void 0==d.avg?d.min:d.avg):v=d.value;d="";d="yes"==x||"yes"==w?d+("\x3ca href\x3d'../environmental/indicatorDetail.html' style\x3d'color: red' onclick\x3d'javascript:detailClick("+p+","+m+");' id\x3d"+p+"\x3e"+v.toString().substring(0,5)+u+"\x3c/a\x3e"):d+("\x3ca href\x3d'../environmental/indicatorDetail.html' style\x3d'color: green' onclick\x3d'javascript:detailClick("+p+","+m+");' id\x3d"+p+"\x3e"+v.toString().substring(0,5)+u+"\x3c/a\x3e");k+="\x3cspan class\x3d'siteInfoWindow'\x3e"+r+"\u6d53\u5ea6\uff1a"+d+"\x3c/span\x3e"}n=new BMap.InfoWindow(k+("\x3c/div\x3e\x3cdiv style\x3d'float: right;width: 46%;'\x3e\x3cdiv class\x3d'siteInfoWindow'\x3e\x3cspan class\x3d'on-duty'\x3e\x3c/span\x3e \u503c\u73ed\u4eba\uff1aXXX\uff1b\x3c/div\x3e\x3cdiv class\x3d'siteInfoWindow'\x3e\x3cspan class\x3d'alarmNum'\x3e\x3c/span\x3e\x3ca href\x3d'../environmental/alarm.html' style\x3d'color: red' class\x3d'tablelink' id\x3d'"+h+"'\x3e\u544a\u8b66\uff1a"+b+"\u6b21\x3c/a\x3e\uff1b\x3c/div\x3e\x3cdiv class\x3d'siteInfoWindow'\x3e\x3cspan class\x3d'alarmNum'\x3e\x3c/span\x3e\u836f\u5242\u4f59\u91cf\uff1a0\u5428\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e"),{width:300,height:175,title:"\x3cdiv style\x3d'font-weight: bolder;margin-right: 5px;display: inline;'\x3e"+c+"\x3c/div\x3e  [\x3ca href\x3d'../comprehensiveMonitor/siteDetail.html' id\x3d'"+e+"' style\x3d'text-decoration: underline;'\x3e\u8fdb\u5165\u7ad9\u70b9\x3c/a\x3e]"});c={};c.infoWindow=n;c.tableId=f;c.currentPageId=l;c.pageListId=g;c.alarmId=h;c.siteId=e;return c}function z(){$("#alarmWindow").html("");var a={},b=0,c={};a.all="";a=JSON.parse(listdevice(a));if("success"==a.errCode&&0!=a.total){var e=a.deviceList,f=[],l={},a=0,g=new Date;null!=selectDate&&(g=new Date(selectDate));l.start=g.getTime();l.end=g.getTime()+(864E5-1);l.space=18E4;for(var h in e){var k=JSON.stringify(e[h]),g=e[h].id,q=void 0==e[h].type?"":e[h].type,n=void 0==e[h].subs?"":e[h].subs;c[g]=k;var k={},m={};k.id=g;k.time=l;k.devType=q;b++;m.find=k;f.push(m);for(var d in n){var k={},m={},p=n[d].pid,r=void 0==n[d].type?q:n[d].type;k.id=g;k.subId=p;k.time=l;k.devType=r;b++;m.find=k;f.push(m)}}b={};b.multiFind=f;b=JSON.parse(listhiststate(b)).multiResult;h="";for(var t in b)d=b[t],"success"==d.errCode&&(a++,f=d.resultList,d=d.id.split("|"),f=f[f.length-1].A,e=JSON.parse(c[d[0]]),e.lastTime=f,e.subId=d[1],h+="\x3cdiv class\x3d'alarmList borderRadius'\x3e"+a+"\u3001\x3ca href\x3d'../devices/deviceAlarm.html' class\x3d'tablelink'\x3e"+e.name+"\uff1a\u6700\u540e\u4e00\u6b21\u4e0b\u7ebf\u65f6\u95f4\uff1a "+dataFormate(f,"yyyy/MM/dd HH:mm:ss")+"\x3c/a\x3e\x3c/div\x3e");$("#alarmWindow").dialog({title:"\u62a5\u8b66\u4fe1\u606f\u603b("+a+")\u6761"});$("#alarmWindow").append(h)}}function F(a,b){return{elem:"#startday",istime:b,isclear:!0,istoday:!1,format:a,issure:!1,start:laydate.now(0),max:laydate.now(0),choose:function(a){selectDate=a}}}function D(){$("#usual").html("\x3cdiv class\x3d'itab'\x3e\x3cul\x3e\x3c/ul\x3e\x3c/div\x3e");var a=JSON.parse(polusourcedistkey("family"));if("success"==a.errCode&&0!=a.total){var a=a.resultList,b;for(b in a){var c=a[b].family,e="",f="";if(null!=u){var l=null==u[c]?[]:u[c];l.sort(function(a,b){return b.value-a.value});for(var g in l){var h=l[g],k=g,q=(h.value/h.count).toFixed(3),n=100*Number((q/l[0].value).toFixed(3)),m="compareNum",d="green";k++;4>k&&(m="compareNum top3",d="red");e+="\x3cdiv style\x3d'margin: 0px 0px 5px 0px;'\x3e\x3cspan class\x3d'"+m+"'\x3e"+k+"\x3c/span\x3e"+h.name+"\u6d53\u5ea6\u503c:\x3cbr/\x3e\x3cdiv class\x3d'progress'\x3e \x3cspan class\x3d'"+d+"' style\x3d'width: "+n+"%;'\x3e\x3cspan\x3e"+q+"\x3c/span\x3e\x3c/span\x3e\x3c/div\x3e\x3c/div\x3e"}}0==b&&(f="class \x3d 'selected'");$("#usual ul").append("\x3cli\x3e\x3ca href\x3d'#tab"+b+"' "+f+" id\x3d'"+c+"'\x3e"+c+"\x3c/a\x3e\x3c/li\x3e");4>=a.length?$("#usual").append("\x3cdiv id\x3d'tab"+b+"' class\x3d'tabson'\x3e"+e+"\x3c/div\x3e"):$("#usual").append("\x3cdiv id\x3d'tab"+b+"' class\x3d'tabson' style\x3d'margin-top:40px'\x3e"+e+"\x3c/div\x3e")}}}$("#container").css({width:"100%","min-height":"450px",overflow:"hidden",height:$(window).height()-40});0<$(window).height()-435&&$("#container").css({height:$(window).height()-40+"px"});$(window).resize(function(){0<$(window).height()-435&&$("#container").css({height:$(window).height()-40})});(function(){var a={};A=JSON.parse(polusourcedistkey("factory"));if("success"==A.errCode&&0!=A.total){var b=A.resultList,c;for(c in b){var e=b[c].location.province,f=b[c].location.city;void 0==a[e]&&(a[e]=[],a[e].push(f))}b=[];e=0;for(c in a)b.push(c),dsy.add("0_"+e,a[c]),e++;dsy.add("0",b)}})();var B=[];B.push("search1");B.push("search2");setup(B);$("#search1").change(function(){change(1,B);w();z()});$("#search2").change(function(){w();z()});$("#startday").click(function(){laydate(F("YYYY/MM/DD",!1));$("#laydate_clear").click(function(){selectDate=null});addLaydateListener()});$("#searchpng").click(function(){w();z()});$("#showIndicator").change(function(){if("auto"==$("#showIndicator option:selected").val())w();else{r.clearOverlays();var a=document.getElementById("search1"),b=document.getElementById("search2"),a=a.options[a.selectedIndex].value,b=b.options[b.selectedIndex].value,c={};"\u7701\u4efd"!=a?(c.province=a,r.centerAndZoom(a,6),"\u5730\u7ea7\u5e02"!=b&&(c.city=b)):c=null;a={};null!=c&&(a.location=c);a.type="factory";a=JSON.parse(listorg(a));if("success"==a.errCode&&0!=a.total){var a=a.orgList,e;for(e in a){var b=a[e],f=!1,c=void 0==b.location?"":b.location,l=""==c?"":void 0==c.lnt?"":c.lnt,c=""==c?"":void 0==c.lat?"":c.lat,g={},h={},k={},q={},n={},m={};g.include="family|devId|factory|lvalue|dvalue|svalue|lower|higher|location|values|uid|name";q.filter=g;h.asc="time";k.max=50;k.start=0;m.name=b.name;m.uId=b.id;n.factory=m;n.hilo="higher|lower";q.sort=h;null!=selectDate?(g={},h=new Date(selectDate),g.scale="day",g.start=h.getTime(),g.end=h.getTime()+(864E5-1),n.time=g,k=JSON.parse(manvListhist(n,k,q))):k=JSON.parse(manvListNow(n,k,q));"success"==k.errCode&&0!=k.total&&(f=!0);v(l,c,b,f,!1)}}}});(function(){$("#compareWindow").dialog({position:{my:"left bottom",at:"right bottom",of:window},autoOpen:!0,height:300,width:430,modal:!1,closeText:"\u6700\u5c0f\u5316",close:function(){0<=$(".ui-dialog-titlebar-close").attr("class").indexOf("ui-dialog-titlebar-min")?($(".ui-dialog-titlebar-close").addClass("ui-dialog-titlebar-max"),$(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-min"),$(this).dialog({height:300,width:430,closeText:"\u6700\u5c0f\u5316"}),$("#usual1").css("display","block")):($(".ui-dialog-titlebar-close").addClass("ui-dialog-titlebar-min"),$(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-max"),$(this).dialog({height:30,width:100,closeText:"\u6700\u5927\u5316"}),$("#usual1").css("display","none"))},open:function(){$(".ui-dialog-titlebar-close").addClass("ui-dialog-titlebar-max");$(".ui-dialog-buttonpane").hide()}});$("#alarmWindow").dialog({position:{my:"center",at:"left bottom",of:window},autoOpen:!0,height:200,width:200,modal:!1,open:function(){$("#alarmWindow").prev().find("button").hide();$(".ui-dialog-buttonpane").hide()}})})();z();var r=new BMap.Map("container");r.enableScrollWheelZoom();r.enableContinuousZoom();r.addControl(new BMap.NavigationControl);r.addControl(new BMap.OverviewMapControl);r.centerAndZoom("\u5317\u4eac",6);var t=null,u=null;w();var A});var selectDate=null;function detailClick(w,v){setCookie("indicatordata",JSON.stringify(v))};